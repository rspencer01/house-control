{% extends "layout.html" %}

{% block heading %}
Overview
{% endblock %}

{% block content %}
<div class="card-deck">
  <div class="card">
      <h5 class="card-header">Lights
      <button class="btn btn-outline-secondary btn-sm float-right" id="all-off" style="margin-left:5px;">All off</button>
      <button class="btn btn-outline-secondary btn-sm float-right" id="all-on" style="margin-right:5px;">All on</button></h5>
    <div class="card-body">
      <p>
        There are {{ lights | length }} lights, of which {{ lights | counton }} are on.
      </p>
      <table class="table">
        <tbody>
          {% for light in lights %}
            <tr>
              <td class="clickable-link" data-href="{{ url_for('edit_light', light_id=light.id) }}">
                {{ light.name }}
              </td>
              <td class="light-toggle" data-href="{{ url_for('get_updates') }}" data-changeto="{{ "off" if light.latest_state().state else "on" }}" data-light_id="{{ light.id }}" style="text-align:center;">
                <i class="fas-large fas {{ "fa-toggle-on" if light.latest_state().state else "fa-toggle-off" }}"></i>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <p class="card-text"><small class="text-muted">Tap on a light name to edit the light and on the switch to toggle it.</small></p>
    </div>
  </div>

  <div class="card">
    <h5 class="card-header">Debug Data</h5>
    <div class="card-body">
      <p class="card-text">
        {{ data }}
      </p>
      <p class="card-text">
        Last updated {{ last_modified | strftime }}
      </p>
      <p class="card-text"><small class="text-muted">Latest raw dump of received data.</small></p>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script type="text/javascript">
  jQuery(document).ready(function($) {
      $(".light-toggle").click(function(event) {
        event.stopPropagation();
        $.post("{{ url_for('get_updates') }}", { light_id: $(this).data("light_id"), state: $(this).data("changeto")}, function() {
          location.reload(true);
        });
      });
      $("#all-on").click(function(event) {
        event.stopPropagation();
        $.post("{{ url_for('allchange') }}", { state: "on" }, function () {
          location.reload(true);
        });
      });
      $("#all-off").click(function(event) {
        event.stopPropagation();
        $.post("{{ url_for('allchange') }}", { state: "off" }, function () {
          location.reload(true);
        });
      });
  });
</script>
{% endblock %}
